<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ƒêƒÉng tin cho thu√™ - ChoThue.com</title>
    <link rel="stylesheet" href="style.css" />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        background: #f8f9fa;
        padding: 30px 0;
      }
      .post-container {
        max-width: 900px;
        margin: 0 auto;
        background: white;
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
      }
      .post-header {
        background: #053beb;
        color: white;
        padding: 25px;
        text-align: center;
        font-size: 28px;
        font-weight: bold;
        position: relative;
        height: 90px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .post-header-title {
        font-size: 27px;
        text-align: center;
        line-height: 1.3;
        padding: 0 80px;
      }
      .post-header-title span {
        font-size: 19px;
      }
      .close-btn {
        position: absolute;
        right: 20px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 36px;
        cursor: pointer;
        width: 56px;
        height: 56px;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10;
      }
      .post-body {
        padding: 40px;
      }
      .form-group {
        margin-bottom: 25px;
      }
      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: bold;
        color: #333;
      }
      .form-group label span {
        color: red;
      }
      .form-group input,
      .form-group select,
      .form-group textarea {
        width: 100%;
        padding: 14px;
        border: 2px solid #ddd;
        border-radius: 12px;
        font-size: 16px;
        box-sizing: border-box;
      }
      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }
      .post-btn {
        background: #e74c3c;
        color: white;
        padding: 18px 60px;
        border: none;
        border-radius: 50px;
        font-size: 20px;
        font-weight: bold;
        cursor: pointer;
        width: 100%;
      }
      .post-btn:hover {
        background: #c0392b;
      }
      .post-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
      }
      .error {
        color: #e74c3c;
        font-size: 14px;
        margin-top: 5px;
      }
      .success {
        color: #27ae60;
        font-size: 14px;
        margin-top: 5px;
      }
      .loading {
        display: none;
        text-align: center;
        margin: 20px 0;
      }
    </style>
  </head>
  <body>
    <div class="post-container">
      <div class="post-header">
        <div class="post-header-title">
          ƒêƒÇNG TIN CHO THU√ä<br />
          <span>NH√Ä / M·∫∂T B·∫∞NG / PH√íNG TR·ªå</span>
        </div>
        <span class="close-btn" onclick="goBack()">√ó</span>
      </div>

      <div class="post-body">
        <form id="postForm">
          <!-- Lo·∫°i chuy√™n m·ª•c -->
          <div class="form-group">
            <label>Lo·∫°i chuy√™n m·ª•c <span>*</span></label>
            <select id="categoryType" required>
              <option value="">-- Ch·ªçn lo·∫°i chuy√™n m·ª•c --</option>
              <option value="Ph√≤ng tr·ªç, nh√† tr·ªç">Ph√≤ng tr·ªç, nh√† tr·ªç</option>
              <option value="Nh√† nguy√™n cƒÉn">Nh√† nguy√™n cƒÉn</option>
              <option value="Chung c∆∞, cƒÉn h·ªô">Chung c∆∞, cƒÉn h·ªô</option>
              <option value="M·∫∑t b·∫±ng, vƒÉn ph√≤ng">M·∫∑t b·∫±ng, vƒÉn ph√≤ng</option>
              <option value="Kho x∆∞·ªüng">Kho x∆∞·ªüng</option>
            </select>
          </div>

          <!-- ƒê·ªãa ch·ªâ c·ª• th·ªÉ -->
          <div class="form-group">
            <label>ƒê·ªãa ch·ªâ c·ª• th·ªÉ <span>*</span></label>
            <input
              type="text"
              id="address"
              placeholder="V√≠ d·ª•: 123 Nguy·ªÖn Tr√£i, Ph∆∞·ªùng B·∫øn Th√†nh, Qu·∫≠n 1, TP.HCM"
              required
            />
            <div class="error" id="addressError"></div>
          </div>

          <!-- Li√™n h·ªá ch√≠nh ch·ªß -->
          <div class="form-group">
            <label>Li√™n h·ªá ch√≠nh ch·ªß <span>*</span></label>
            <input
              type="text"
              id="contact"
              placeholder="V√≠ d·ª•: Anh ƒê·∫°t - 0769969928 (c√≥ Zalo)"
              required
            />
            <div class="error" id="contactError"></div>
          </div>

          <!-- M·ª©c gi√° -->
          <div class="form-group">
            <label>M·ª©c gi√° (tri·ªáu/th√°ng) <span>*</span></label>
            <input
              type="number"
              id="price"
              placeholder="V√≠ d·ª•: 15"
              min="0"
              required
            />
            <div class="error" id="priceError"></div>
          </div>

          <!-- Di·ªán t√≠ch -->
          <div class="form-group">
            <label>Di·ªán t√≠ch (m¬≤)</label>
            <input type="number" id="area" placeholder="V√≠ d·ª•: 80" min="0" />
          </div>

          <!-- M√¥ t·∫£ chi ti·∫øt -->
          <div class="form-group">
            <label>Th√¥ng tin m√¥ t·∫£ <span>*</span></label>
            <textarea
              id="description"
              placeholder="M√¥ t·∫£ chi ti·∫øt v·ªÅ nh√†, ti·ªán √≠ch, n·ªôi th·∫•t..."
              required
              rows="6"
            ></textarea>
            <div class="error" id="descriptionError"></div>
          </div>

          <!-- ·∫¢nh -->
          <div class="form-group">
            <label>·∫¢nh (t·ªëi ƒëa 10 ·∫£nh)</label>
            <input type="file" id="images" multiple accept="image/*" />
            <div class="error" id="imagesError"></div>
            <div
              id="imagePreview"
              style="
                margin-top: 15px;
                display: flex;
                gap: 10px;
                flex-wrap: wrap;
              "
            ></div>
          </div>

          <div class="loading" id="loading">
            <i class="fas fa-spinner fa-spin"></i> ƒêang x·ª≠ l√Ω...
          </div>

          <div style="text-align: center; margin-top: 50px">
            <button type="submit" class="post-btn" id="submitBtn">
              ƒêƒÇNG TIN NGAY
            </button>
            <div class="error" id="formError" style="margin-top: 15px"></div>
            <div
              class="success"
              id="formSuccess"
              style="margin-top: 15px"
            ></div>
          </div>
        </form>
      </div>
    </div>

    <script src="script.js"></script>
    <script>
      // üìã KI·ªÇM TRA ƒêƒÇNG NH·∫¨P TR∆Ø·ªöC KHI V√ÄO TRANG
      window.addEventListener("load", function () {
        const user = localStorage.getItem("user");
        const token = localStorage.getItem("token");

        if (!user || !token) {
          alert("‚ùå B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p tr∆∞·ªõc khi ƒëƒÉng tin!");
          window.location.href = "index.html";
          return;
        }

        updateUserMenu();
      });

      // üîÑ C·∫¨P NH·∫¨T MENU NG∆Ø·ªúI D√ôNG
      function updateUserMenu() {
        const user = localStorage.getItem("user");
        const guestMenu = document.getElementById("guestMenu");
        const userMenu = document.getElementById("userMenu");
        const userNameEl = document.getElementById("userName");

        if (user && userNameEl && userMenu && guestMenu) {
          const parsed = JSON.parse(user);
          guestMenu.style.display = "none";
          userMenu.style.display = "block";
          userNameEl.innerHTML = `${
            parsed.name || parsed.phone
          } <i class="fas fa-caret-down"></i>`;
        }
      }

      // üì∏ X·ª¨ L√ù XEM TR∆Ø·ªöC H√åNH ·∫¢NH
      document
        .getElementById("images")
        .addEventListener("change", function (e) {
          const preview = document.getElementById("imagePreview");
          preview.innerHTML = "";

          if (this.files.length > 10) {
            document.getElementById("imagesError").textContent =
              "‚ùå T·ªëi ƒëa 10 ·∫£nh";
            return;
          }

          document.getElementById("imagesError").textContent = "";

          Array.from(this.files).forEach((file, idx) => {
            const reader = new FileReader();
            reader.onload = function (e) {
              const img = document.createElement("img");
              img.src = e.target.result;
              img.style.width = "80px";
              img.style.height = "80px";
              img.style.objectFit = "cover";
              img.style.borderRadius = "8px";
              preview.appendChild(img);
            };
            reader.readAsDataURL(file);
          });
        });

      // üì§ G·ª¨I FORM ƒê·∫æN API
      document
        .getElementById("postForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          // üîê L·∫•y token t·ª´ localStorage
          const token = localStorage.getItem("token");
          if (!token) {
            document.getElementById("formError").textContent =
              "‚ùå Token kh√¥ng h·ª£p l·ªá, vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i";
            return;
          }

          // üìã KI·ªÇM VALIDATE D·ªÆ LI·ªÜU
          const categoryType = document.getElementById("categoryType").value;
          const address = document.getElementById("address").value.trim();
          const contact = document.getElementById("contact").value.trim();
          const price = document.getElementById("price").value;
          const description = document
            .getElementById("description")
            .value.trim();

          document.getElementById("formError").textContent = "";
          document.getElementById("addressError").textContent = "";
          document.getElementById("contactError").textContent = "";
          document.getElementById("priceError").textContent = "";
          document.getElementById("descriptionError").textContent = "";

          let hasError = false;

          if (!categoryType) {
            document.getElementById("formError").textContent =
              "‚ùå Vui l√≤ng ch·ªçn lo·∫°i chuy√™n m·ª•c";
            hasError = true;
          }
          if (!address) {
            document.getElementById("addressError").textContent =
              "‚ùå ƒê·ªãa ch·ªâ kh√¥ng ƒë∆∞·ª£c tr·ªëng";
            hasError = true;
          }
          if (!contact) {
            document.getElementById("contactError").textContent =
              "‚ùå Th√¥ng tin li√™n h·ªá kh√¥ng ƒë∆∞·ª£c tr·ªëng";
            hasError = true;
          }
          if (!price || price <= 0) {
            document.getElementById("priceError").textContent =
              "‚ùå Gi√° ph·∫£i l·ªõn h∆°n 0";
            hasError = true;
          }
          if (!description) {
            document.getElementById("descriptionError").textContent =
              "‚ùå M√¥ t·∫£ kh√¥ng ƒë∆∞·ª£c tr·ªëng";
            hasError = true;
          }

          if (hasError) return;

          // üîÑ CHU·∫®N B·ªä D·ªÆ LI·ªÜU
          const formData = new FormData();
          formData.append("category", categoryType);
          formData.append("address", address);
          formData.append("contact", contact);
          formData.append("price", parseFloat(price));
          formData.append("area", document.getElementById("area").value || 0);
          formData.append("description", description);
          formData.append("title", `${categoryType} t·∫°i ${address}`); // T·∫°o ti√™u ƒë·ªÅ t·ª± ƒë·ªông

          // Th√™m ·∫£nh n·∫øu c√≥
          const files = document.getElementById("images").files;
          for (let i = 0; i < files.length; i++) {
            formData.append("images", files[i]);
          }

          // üöÄ G·ª¨I REQUEST ƒê·∫æN API
          document.getElementById("submitBtn").disabled = true;
          document.getElementById("loading").style.display = "block";

          try {
            const response = await fetch("http://localhost:5000/api/posts", {
              method: "POST",
              headers: {
                Authorization: `Bearer ${token}`,
              },
              body: formData,
            });

            const data = await response.json();

            if (response.ok) {
              document.getElementById("formSuccess").textContent =
                "‚úÖ ƒêƒÉng tin th√†nh c√¥ng! S·∫Ω quay v·ªÅ trang ch·ªß...";
              setTimeout(() => {
                window.location.href = "index.html";
              }, 2000);
            } else {
              document.getElementById("formError").textContent = `‚ùå L·ªói: ${
                data.message || "Kh√¥ng th·ªÉ ƒëƒÉng tin"
              }`;
            }
          } catch (error) {
            document.getElementById(
              "formError"
            ).textContent = `‚ùå L·ªói: ${error.message}`;
          } finally {
            document.getElementById("submitBtn").disabled = false;
            document.getElementById("loading").style.display = "none";
          }
        });

      // üîô QUAY L·∫†I TRANG TR∆Ø·ªöC
      function goBack() {
        if (
          document.referrer.includes("index.html") ||
          document.referrer === ""
        ) {
          window.history.back();
        } else {
          window.location.href = "index.html";
        }
      }
    </script>
  </body>
</html>
